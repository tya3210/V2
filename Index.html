<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>防災マップアプリ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map { height: 100vh; }
        .info-panel { background: rgba(255,255,255,0.9); padding: 15px; }
        .expired { color: #dc3545; }
        .warning { color: #ffc107; }
        .leaflet-control-layers { background: white; padding: 10px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- コントロールパネル -->
    <div class="leaflet-control-layers info-panel leaflet-bar fixed-top m-3" style="left: 20px; top: 20px;">
        <div class="mb-3">
            <button class="btn btn-sm btn-primary" onclick="addMessageMarker()">
                伝言を追加
            </button>
        </div>
        
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="hazardLayer" checked>
            <label class="form-check-label" for="hazardLayer">ハザードマップ</label>
        </div>
        
        <div class="mt-3">
            <input type="text" class="form-control form-control-sm" 
                   id="searchBox" placeholder="住所検索">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // 地図初期化
        const map = L.map('map').setView([35.681236, 139.767125], 13);
        
        // 国土地理院タイルレイヤー
        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
            maxZoom: 18
        }).addTo(map);

        // レイヤー管理
        const layers = {
            hazard: L.layerGroup().addTo(map),
            messages: L.layerGroup(),
            shelters: L.layerGroup()
        };

        // サンプルデータ（実際はローカルストレージ等と連携）
        const sampleData = {
            hazardAreas: [
                {
                    coords: [[35.68,139.76], [35.68,139.77], [35.67,139.77]],
                    type: '洪水'
                }
            ],
            shelters: [
                {lat: 35.6812, lng: 139.7671, name: "中央避難所", capacity: 300},
                {lat: 35.6830, lng: 139.7645, name: "公園避難所", capacity: 150}
            ]
        };

        // ハザードマップ表示
        function renderHazardAreas() {
            sampleData.hazardAreas.forEach(area => {
                L.polygon(area.coords, {
                    color: '#ff0000',
                    fillOpacity: 0.2
                }).bindPopup(`危険区域: ${area.type}`)
                .addTo(layers.hazard);
            });
        }

        // 避難所マーカー表示
        function renderShelters() {
            sampleData.shelters.forEach(shelter => {
                L.marker([shelter.lat, shelter.lng])
                    .bindPopup(`
                        <b>${shelter.name}</b><br>
                        収容人数: ${shelter.capacity}人
                    `)
                    .addTo(layers.shelters);
            });
        }

        // 伝言マーカー追加機能
        function addMessageMarker() {
            const message = prompt('伝言を入力してください（最大100文字）:');
            if(message && message.length <= 100) {
                map.once('click', e => {
                    L.marker(e.latlng)
                        .bindPopup(`
                            <div class="message-popup">
                                ${new Date().toLocaleString()}<br>
                                ${message}
                            </div>
                        `)
                        .addTo(layers.messages);
                });
                alert('地図上で位置をクリックしてください');
            }
        }

        // 初期表示処理
        renderHazardAreas();
        renderShelters();

        // レイヤー制御
        document.getElementById('hazardLayer').addEventListener('change', e => {
            e.target.checked ? layers.hazard.addTo(map) : map.removeLayer(layers.hazard);
        });

        // 簡易住所検索
        document.getElementById('searchBox').addEventListener('keypress', async e => {
            if(e.key === 'Enter') {
                const query = e.target.value;
                try {
                    const response = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${query}`);
                    const data = await response.json();
                    if(data[0]?.geometry?.coordinates) {
                        const [lng, lat] = data[0].geometry.coordinates;
                        map.flyTo([lat, lng], 16);
                    }
                } catch (error) {
                    alert('住所の検索に失敗しました');
                }
            }
        });
    </script>
</body>
</html>
